<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Checkout - Stranger Things Store</title>
    <link rel="stylesheet" href="styles.css?v=18">
    <link rel="stylesheet" href="checkout-styles.css?v=18">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS CR√çTICO INLINE - FOR√áAR desde o in√≠cio */
        body:has(.announcement-bar:not(.hidden)),
        body.has-announcement {
            padding-top: 108px !important;
        }

        /* Header SEMPRE abaixo do announcement bar */
        body:has(.announcement-bar:not(.hidden)) .header,
        body.has-announcement .header,
        .announcement-bar:not(.hidden)~.header {
            top: 48px !important;
            z-index: 1003 !important;
        }

        /* Announcement bar SEMPRE no topo */
        .announcement-bar:not(.hidden) {
            position: fixed !important;
            top: 0 !important;
            z-index: 1004 !important;
            height: 48px !important;
        }

        /* Loading Screen Inicial */
        #checkoutPageLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #000000 0%, #0a0000 100%);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.4s ease-out;
        }

        #checkoutPageLoader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader-content {
            text-align: center;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-spinner {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 2rem;
        }

        .loader-spinner::before,
        .loader-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 50%;
        }

        .loader-spinner::before {
            width: 100%;
            height: 100%;
            border: 4px solid rgba(229, 9, 20, 0.1);
        }

        .loader-spinner::after {
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #E50914;
            animation: loaderSpin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }

        .loader-text {
            font-family: 'Teko', sans-serif;
            font-size: 2rem;
            color: #E50914;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(229, 9, 20, 0.5);
            animation: loaderGlow 2s ease-in-out infinite;
            margin: 0;
            text-align: center;
        }

        .loader-subtext {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            letter-spacing: 1px;
            text-align: center;
        }

        @keyframes loaderSpin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes loaderGlow {

            0%,
            100% {
                text-shadow: 0 0 20px rgba(229, 9, 20, 0.5), 0 0 40px rgba(229, 9, 20, 0.3);
            }

            50% {
                text-shadow: 0 0 30px rgba(229, 9, 20, 0.8), 0 0 60px rgba(229, 9, 20, 0.5);
            }
        }

        /* Esconder conte√∫do da p√°gina enquanto carrega */
        body.loading .checkout-container,
        body.loading .header,
        body.loading .announcement-bar,
        body.loading footer {
            opacity: 0;
            visibility: hidden;
        }
    </style>
    <script>
        // FOR√áAR layout correto IMEDIATAMENTE
        (function () {
            function forceFixedLayout() {
                if (!document.body) return;

                const announcementBar = document.querySelector('.announcement-bar');
                const header = document.querySelector('.header');

                if (announcementBar && !announcementBar.classList.contains('hidden')) {
                    document.body.classList.add('has-announcement');

                    if (header) {
                        header.style.setProperty('top', '48px', 'important');
                        header.style.setProperty('z-index', '1003', 'important');
                    }

                    if (announcementBar) {
                        announcementBar.style.setProperty('z-index', '1004', 'important');
                        announcementBar.style.setProperty('top', '0', 'important');
                        announcementBar.style.setProperty('height', '48px', 'important');
                    }
                } else {
                    document.body.classList.remove('has-announcement');

                    if (header) {
                        header.style.setProperty('top', '0', 'important');
                    }
                }
            }

            if (document.body) {
                forceFixedLayout();
            }

            const checkBody = setInterval(function () {
                if (document.body) {
                    clearInterval(checkBody);
                    forceFixedLayout();
                }
            }, 1);

            ['DOMContentLoaded', 'load'].forEach(function (event) {
                document.addEventListener(event, forceFixedLayout);
            });

            let count = 0;
            const forceInterval = setInterval(function () {
                forceFixedLayout();
                count++;
                if (count >= 10) clearInterval(forceInterval);
            }, 100);
        })();
    </script>
</head>

<body class="checkout-page loading">
    <!-- Page Loader -->
    <div id="checkoutPageLoader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">CARREGANDO CHECKOUT</div>
            <div class="loader-subtext">Preparando sua experi√™ncia...</div>
        </div>
    </div>

    <div class="grid-background"></div>

    <!-- Top Announcement Bar -->
    <div class="announcement-bar">
        <div class="container">
            <p>‚ú® <strong>OFERTA ESPECIAL:</strong> 20% OFF em todo o site com c√≥digo <strong>STRANGER20</strong> -
                V√°lido at√© 31/01</p>
            <button class="announcement-close" aria-label="Fechar an√∫ncio">&times;</button>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <div class="header-top">
                <div class="logo">
                    <a href="index.html">
                        <img src="logo.png" alt="Stranger Things Store" class="logo-img">
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="checkout-container">
        <div class="checkout-header">
            <h1 class="checkout-title">Finalizar Compra</h1>
            <p class="checkout-subtitle">Complete seus dados para concluir o pedido</p>
        </div>

        <div class="checkout-grid" id="checkoutContent">
            <!-- Content will be loaded by JavaScript -->
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 Stranger Things Store. Todos os direitos reservados.</p>
                <p class="disclaimer">STRANGER THINGS ‚Ñ¢/ ¬© Netflix 2024</p>
            </div>
        </div>
    </footer>

    <script>
        // Announcement bar close
        const announcementClose = document.querySelector('.announcement-close');
        if (announcementClose) {
            announcementClose.addEventListener('click', () => {
                document.querySelector('.announcement-bar').classList.add('hidden');
            });
        }

        // Hide page loader quando DOMContentLoaded (n√£o esperar imagens)
        document.addEventListener('DOMContentLoaded', function () {
            // Remover classe loading do body
            document.body.classList.remove('loading');

            // Esconder loader ap√≥s um delay m√≠nimo
            setTimeout(function () {
                const loader = document.getElementById('checkoutPageLoader');
                if (loader) {
                    loader.classList.add('hidden');
                    // Remove loader do DOM ap√≥s anima√ß√£o
                    setTimeout(function () {
                        loader.remove();
                    }, 400);
                }
            }, 200); // Delay m√≠nimo de 200ms para garantir transi√ß√£o suave
        });

        // Fallback: esconder loader ap√≥s 2 segundos se DOMContentLoaded n√£o disparar
        setTimeout(function () {
            document.body.classList.remove('loading');
            const loader = document.getElementById('checkoutPageLoader');
            if (loader && !loader.classList.contains('hidden')) {
                loader.classList.add('hidden');
            }
        }, 2000);
    </script>
    <!-- Payment Processing Modal -->
    <div id="paymentModal" class="payment-modal-overlay">
        <div class="payment-modal">
            <!-- Loading State -->
            <div id="modalLoading" class="payment-modal-content">
                <div class="modal-spinner"></div>
                <h3 class="modal-title">Processando Pagamento...</h3>
                <p class="modal-text">Por favor, aguarde enquanto validamos sua transa√ß√£o com a operadora.</p>
                <p class="modal-text"><small>N√£o feche esta janela.</small></p>
            </div>

            <!-- Success State -->
            <div id="modalSuccess" class="payment-modal-content hidden">
                <div class="icon-success">‚úì</div>
                <h3 class="modal-title">Pagamento Aprovado!</h3>
                <p class="modal-text">Sua compra foi confirmada com sucesso.</p>
                <p class="modal-text">Redirecionando...</p>
            </div>

            <!-- Error State -->
            <div id="modalError" class="payment-modal-content hidden">
                <div class="icon-error">!</div>
                <h3 class="modal-title">Pagamento Recusado</h3>
                <p id="paymentErrorMessage" class="modal-text">Ocorreu um erro ao processar o pagamento.</p>
                <button id="btnRetryPayment" class="btn-retry">TENTAR NOVAMENTE</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <!-- Core Scripts -->
    <script>
        (async function () {
            try {
                const r = await fetch('/api/tracking/meta-pixel');
                if (!r.ok) return;
                const d = await r.json();
                if (d.pixel_id && d.is_active) {
                    console.log('üîπ Pixel Init:', d.pixel_id);
                    !function (f, b, e, v, n, t, s) { if (f.fbq) return; n = f.fbq = function () { n.callMethod ? n.callMethod.apply(n, arguments) : n.queue.push(arguments) }; if (!f._fbq) f._fbq = n; n.push = n; n.loaded = !0; n.version = '2.0'; n.queue = []; t = b.createElement(e); t.async = !0; t.src = v; s = b.getElementsByTagName(e)[0]; s.parentNode.insertBefore(t, s) }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
                    fbq('init', d.pixel_id);
                    fbq('track', 'PageView');
                    window.metaPixel = {
                        trackPurchase: (oid, val, items) => { fbq('track', 'Purchase', { currency: 'BRL', value: val, content_type: 'product', order_id: oid, content_ids: items ? items.map(i => i.id) : [] }); },
                        trackInitiateCheckout: (val, items) => { fbq('track', 'InitiateCheckout', { currency: 'BRL', value: val, content_type: 'product', content_ids: items ? items.map(i => i.id) : [] }); },
                        trackAddToCart: (item) => { fbq('track', 'AddToCart', { currency: 'BRL', value: item.price, content_type: 'product', content_ids: [item.id], content_name: item.name }); },
                        trackViewContent: (p) => { fbq('track', 'ViewContent', { currency: 'BRL', value: p.price, content_type: 'product', content_ids: [p.id], content_name: p.name }); }
                    };
                    window.dispatchEvent(new Event('metaPixelReady'));
                }
            } catch (e) { console.warn('Pixel Error:', e); }
        })();
    </script>
    <script src="checkout.js"></script>
    <script src="script.js?v=2.7"></script> <!-- Analytics Tracking -->
    <script>
        // Meta Pixel: Track InitiateCheckout when page loads
        window.addEventListener('load', function () {
            if (typeof window.metaPixel !== 'undefined' && window.cart && window.cart.length > 0) {
                const total = window.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                window.metaPixel.trackInitiateCheckout(window.cart, total);
            }
        });
    </script>
</body>

</html>